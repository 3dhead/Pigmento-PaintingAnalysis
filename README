To run all the code, you may need change "base_dir" variable in "step1_ANLS_with_autograd.py". Sorry for the inconvenience. 


Install:
	 Python
	 Numpy
	 Scipy
	 Pillow
	 numba
	 matplotlib
	 autograd
	 joblib
	 scikit-image
	 scikit-learn
	 cvxopt (with 'glpk' solver option)


Three main code are:
	1.step1_ANLS_with_autograd.py
	2.Solve_KM_mixing_model_fixed_KS_with_autograd.py
	3.Solve_KM_layer_model_fixed_KS_with_autograd.py
Other code files are imported in these three files.


The input image should be a good size, like 600by600. if it is 1000by1000. It will be slow for weights exraction or layer extraction.




Commands (run 1 first, then run 2 or 3): 

1. Extract primary pigments: 

Everytime you run this code for same input image, you will get a very small different primary pigment set, because sampling pixels is random (although I am sampling color bin in RGB space, but sampling is random. You can run once, then run command 2 and 3. Or you can run multiple times, choose what you like, actually multiple times running will give you some simiar primary pigment results.

User can give number of pigmetns, for example, 6 in the command line below.


	cd /new_pipeline_exectuable

	python step1_ANLS_with_autograd.py wheatfield-crop.png Existing_KS_parameter_KS.txt 2 None wheatfield-sampled_pixels-400 0 6 10.0 0.0 0.0 0.001 0.001 1e-6 /wheatfield-crop None 0 1 1000 400



2. Extract mixing weights:


	cd /new_pipeline_exectuable/wheatfield-crop

	python ../Solve_KM_mixing_model_fixed_KS_with_autograd.py wheatfield-crop.png  primary_pigments_KS-6.txt  None wheatfield-crop-primary_pigments_color_vertex-6-KM_weights-W_w_10.0-W_sparse_0.1-W_spatial_1.0-choice_0-blf-W_neighbors_0.0-Recursive_Yes 10.0 0.1 0 1.0 0.0 blf Yes



3. Extract layers: 
You need create a layer order file manually, for example: "wheatfield-pigments-order1.txt" 

	cd /new_pipeline_exectuable/wheatfield-crop

	python ../Solve_KM_layer_model_fixed_KS_with_autograd.py wheatfield-crop.png  primary_pigments_KS-6.txt  None wheatfield-crop-primary_pigments_color_vertex-6-KM_layers-W_w_10.0-W_sparse_0.1-W_spatial_1.0-choice_0-blf-W_neighbors_0.0-Recursive_Yes-order1 10.0 0.1 0 1.0 0.0 blf Yes wheatfield-pigments-order1.txt






